<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>View Flashcard Sets</title>
    <link rel="stylesheet" href="view_flashcards.css">
</head>

<body>
    <!-- Home button -->
    <a id="home-btn" href="home.html">Home</a>
    <a id="back-btn" style="display: none;" href="javascript:void(0)" onclick="showSubjects()">Back</a>

    <h2 style="color: white;">Flashcard Sets</h2>

    <input type="text" id="search-bar" placeholder="Search sets..."
        style="display: none; margin-bottom: 10px; padding: 5px; width: 90%; max-width: 400px;">

    <div id="subject-list">
        <!-- 2x3 grid of subject buttons -->
        <div class="subject-button-container">
            <button onclick="loadFlashcardSetsBySubject('math')">Math</button>
            <button onclick="loadFlashcardSetsBySubject('science')">Science</button>
            <button onclick="loadFlashcardSetsBySubject('social studies')">Social Studies</button>
            <button onclick="loadFlashcardSetsBySubject('languages')">Languages</button>
            <!-- "Other" button aligned to the right side and matched with the height of the right column -->
            <button onclick="loadFlashcardSetsBySubject('other')">Other</button>
        </div>
    </div>

    <!-- List of Flashcard Sets -->
    <div id="flashcard-set-list" style="display: none;">
        <!-- Flashcard set buttons will be added here dynamically -->
    </div>

    <!-- Flashcard Set Details -->
    <div id="flashcard-details" style="display: none;">
        <div id="set-info">
            <h3 id="set-name" style="color: white;"></h3>
            <p style="color: white;"><strong>Created by:</strong> <span id="creator-name"></span></p>
        </div>

        <div id="flashcards-container">
            <!-- Flashcards will be displayed here dynamically -->
        </div>
    </div>

    <!-- Firebase App and Firestore SDKs -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="search.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBxR-gB1srBMUlQNvwOy1M2fVHIKaClTZs",
            authDomain: "sweflashcardwebsite.firebaseapp.com",
            projectId: "sweflashcardwebsite",
            storageBucket: "sweflashcardwebsite.appspot.com",
            messagingSenderId: "1017040813605",
            appId: "1:1017040813605:web:fe254a4afe244d341909cc",
            measurementId: "G-NHEQY035NK"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        // Function to check if the current user is an admin
        async function checkIfAdmin() {
            const user = auth.currentUser;
            if (user) {
                try {
                    const userDoc = await db.collection('users').doc(user.uid).get();
                    return userDoc.exists && userDoc.data().role === 'admin';
                } catch (error) {
                    console.error("Error checking if user is admin:", error);
                    return false;
                }
            }
            return false;
        }

        // Function to show and enable the search bar
        // Function to show and enable the search bar
        // Function to show and enable the search bar
        function showSearchBar() {
            const searchBar = document.getElementById('search-bar');
            searchBar.style.display = 'block';

            // Add event listener only if it hasn't been added before
            if (!searchBar.dataset.listenerAdded) {
                searchBar.addEventListener('input', () => {
                    const filter = searchBar.value.toLowerCase();
                    const sets = document.querySelectorAll('#flashcard-set-list .set-container');

                    sets.forEach((setContainer) => {
                        const setButton = setContainer.querySelector('button');
                        const setName = setButton.textContent.toLowerCase();
                        const deleteButton = setContainer.querySelector('.delete-btn');

                        // Check if the set name matches the search query
                        const matchesSearch = setName.includes(filter);

                        // Show/hide the set container (button and delete button)
                        setContainer.style.display = matchesSearch ? 'flex' : 'none';

                        // Only show the delete button if the set is visible and user is admin
                        if (deleteButton) {
                            deleteButton.style.display = (matchesSearch && setContainer.style.display !== 'none') ? 'inline-block' : 'none';
                        }
                    });
                });
                searchBar.dataset.listenerAdded = 'true';
            }
        }


        // Function to hide and reset the search bar
        function hideSearchBar() {
            const searchBar = document.getElementById('search-bar');
            searchBar.style.display = 'none';
            searchBar.value = '';
        }

        // Load flashcard sets for the selected subject
        async function loadFlashcardSetsBySubject(subject) {
            const flashcardSetList = document.getElementById('flashcard-set-list');
            const searchBar = document.getElementById('search-bar');

            // Clear previous sets and hide subject list
            flashcardSetList.innerHTML = '';
            document.getElementById('subject-list').style.display = 'none';
            flashcardSetList.style.display = 'block';
            document.getElementById('back-btn').style.display = 'block';

            try {
                // Fetch data from Firestore
                const setsSnapshot = await db.collection('flashcardsets').doc(subject).collection('sets').get();

                if (setsSnapshot.empty) {
                    flashcardSetList.innerHTML = `<p>No flashcard sets found for ${subject}.</p>`;
                } else {
                    // Populate flashcard sets
                    const isAdmin = await checkIfAdmin();
                    setsSnapshot.forEach((doc) => {
                        const setData = doc.data();
                        const setId = doc.id;

                        const setContainer = document.createElement('div');
                        setContainer.classList.add('set-container');

                        const button = document.createElement('button');
                        button.textContent = setData.name;
                        button.onclick = () => loadFlashcardSetDetails(subject, setId);

                        setContainer.appendChild(button);

                        // Add delete button for admins
                        // Add delete button for admins
                        if (isAdmin) {
                            const deleteButton = document.createElement('button');
                            deleteButton.textContent = 'Delete';
                            deleteButton.classList.add('delete-btn'); // Add this line to apply the correct class
                            deleteButton.onclick = () => deleteFlashcardSet(subject, setId);
                            setContainer.appendChild(deleteButton);
                        }

                        flashcardSetList.appendChild(setContainer);
                    });

                    // Display the search bar
                    showSearchBar();
                }
            } catch (error) {
                console.error("Error loading flashcard sets for subject:", error);
                flashcardSetList.innerHTML = `<p>Failed to load flashcard sets. Please try again later.</p>`;
            }
        }

        // Load details of a flashcard set
        async function loadFlashcardSetDetails(subject, setId) {
            const flashcardSetListDiv = document.getElementById('flashcard-set-list');
            const flashcardDetailsDiv = document.getElementById('flashcard-details');
            const setNameElement = document.getElementById('set-name');
            const creatorNameElement = document.getElementById('creator-name');
            const flashcardsContainer = document.getElementById('flashcards-container');

            flashcardsContainer.innerHTML = ''; // Clear previous flashcard details

            try {
                const setDoc = await db.collection('flashcardsets').doc(subject).collection('sets').doc(setId).get();

                if (setDoc.exists) {
                    const setData = setDoc.data();

                    setNameElement.textContent = setData.name;
                    creatorNameElement.textContent = await getUsernameByUID(setData.creator);

                    flashcardSetListDiv.style.display = 'none';
                    flashcardDetailsDiv.style.display = 'block';

                    // Hide the search bar
                    hideSearchBar();

                    setData.flashcards.forEach((flashcard) => {
                        const flashcardDiv = document.createElement('div');
                        flashcardDiv.classList.add('flashcard');

                        const frontDiv = document.createElement('div');
                        frontDiv.classList.add('front');
                        frontDiv.innerHTML = `<strong>Front:</strong> ${flashcard.front}`;

                        const backDiv = document.createElement('div');
                        backDiv.classList.add('back');
                        backDiv.innerHTML = `<strong>Back (Options):</strong>`;

                        flashcard.back.forEach((option) => {
                            const optionDiv = document.createElement('div');
                            optionDiv.classList.add('option');
                            if (option.isCorrect) {
                                optionDiv.classList.add('correct');
                            }
                            optionDiv.textContent = option.option;
                            backDiv.appendChild(optionDiv);
                        });

                        flashcardDiv.appendChild(frontDiv);
                        flashcardDiv.appendChild(backDiv);

                        flashcardsContainer.appendChild(flashcardDiv);
                    });
                } else {
                    alert("Flashcard set not found.");
                }
            } catch (error) {
                console.error("Error loading flashcard set details:", error);
            }
        }

        // Fetch username by UID
        async function getUsernameByUID(uid) {
            try {
                const userDoc = await db.collection('users').doc(uid).get();
                return userDoc.exists ? userDoc.data().username : "Unknown";
            } catch (error) {
                console.error("Error fetching username:", error);
                return "Unknown";
            }
        }

        // Delete a flashcard set
        async function deleteFlashcardSet(subject, setId) {
            try {
                await db.collection('flashcardsets').doc(subject).collection('sets').doc(setId).delete();
                alert("Flashcard set deleted successfully.");
                loadFlashcardSetsBySubject(subject); // Refresh the list
            } catch (error) {
                console.error("Error deleting flashcard set:", error);
                alert("Failed to delete flashcard set.");
            }
        }

        // Function to show subjects view
        function showSubjects() {
            document.getElementById('subject-list').style.display = 'flex'; // Display subject list container
            document.getElementById('flashcard-set-list').style.display = 'none'; // Hide flashcard set list
            document.getElementById('flashcard-details').style.display = 'none'; // Hide flashcard details
            document.getElementById('back-btn').style.display = 'none'; // Hide back button
            hideSearchBar(); // Reset search bar visibility and value

            // Adjust the layout after going back
            resetSubjectButtonLayout();
        }

        // Function to reset the layout of subject buttons after back button is pressed
        function resetSubjectButtonLayout() {
            const subjectList = document.getElementById('subject-list');

            // Recalculate the layout and apply the necessary styles
            subjectList.style.display = 'flex';
            subjectList.style.flexWrap = 'wrap';
            subjectList.style.justifyContent = 'center'; // Recenter the buttons
        }

    </script>
</body>

</html>